#' @export

ccir_timeseries_exploitation_plots <- function(x, xrange = NULL, running.median =T ,  running.length = 3,fname = NULL,sex.ratio = NULL,bio.project ='bio.lobster',by.sex=F) {
	#x is output from ccir_collapse_summary 
	# both sexes same plot
	if(is.null(fname)) fname = paste('TS.exploitation',x$LFA[1],x$Grid[1],'png',sep=".")	
	if(is.null(xrange)) xr = range(x$Yr)
	if(is.null(sex.ratio)) sr = 0.5
	yr = c(0,1)
	fdir = file.path(project.figuredirectory(bio.project),'ccir')
	if(!dir.exists(fdir)) dir.create(fdir,recursive=T, showWarnings=F)


	xlab = 'Year'
	ylab = 'Exploitation Index'
if(by.sex) {
with(subset(x,Sex==1),{
	Yr = Yr-0.1
	plot(Yr,ERfm,xlab=xlab,ylab=ylab,xlim=xr,ylim=yr,type='p',pch=16,col=1)
	arrows(x0 = Yr,y0 = ERfm,y1 = ERfu,length=0,lwd=1,col=1)
	arrows(x0 = Yr,y0 = ERfm,y1 = ERfl,length=0,lwd=1,col=1)
  		})

with(subset(x,Sex==2),{
	Yr = Yr+0.1
	points(Yr,ERfm,pch=18,col=2)
	arrows(x0 = Yr,y0 = ERfm,y1 = ERfu,length=0,lwd=1,col=2,lty=2)
	arrows(x0 = Yr,y0 = ERfm,y1 = ERfl,length=0,lwd=1,col=2,lty=2)
		})
x$Wts = x$NRef + x$NExp
  b = as.data.frame(sapply(split(x,x$Yr),function(x) weighted.mean(x$ERfm,w=x$Wts)))
  names(b) <- 'WtMean'
  b$Yr = rownames(b)
  with(b,{
      	rmean = runmed(WtMean,k=running.length,endrule='median')
        rmean.yr = Yr[1:length(Yr)]
		  lines(rmean.yr,rmean,lty=1,lwd=2,col='blue')
		  })
	legend('bottomleft',lty=c(0,0,1),pch=c(16,16,0),legend=c('Male','Female','Weighted Running Median'),col=c('black','red','blue'))
	} else {


		with(x,{
	Yr = Yr
	plot(Yr,ERfm,xlab=xlab,ylab=ylab,xlim=xr,ylim=yr,type='p',pch=16,col=1)
	arrows(x0 = Yr,y0 = ERfm,y1 = ERfu,length=0,lwd=1,col=1)
	arrows(x0 = Yr,y0 = ERfm,y1 = ERfl,length=0,lwd=1,col=1)
      	rmean = runmed(ERfm,k=running.length,endrule='median')
        rmean.yr = Yr[1:length(Yr)]
		  lines(rmean.yr,rmean,lty=1,lwd=2,col='blue')
		  })
	}
	savePlot(file.path(fdir,fname),type='png')

}